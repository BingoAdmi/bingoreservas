<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo - Sistema Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, where, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      
      // Hacemos que las funciones de Firebase est√©n disponibles globalmente
      window.initializeApp = initializeApp;
      window.getFirestore = getFirestore;
      window.collection = collection;
      window.doc = doc;
      window.setDoc = setDoc;
      window.deleteDoc = deleteDoc;
      window.onSnapshot = onSnapshot;
      window.query = query;
      window.where = where;
      window.getDoc = getDoc;
      window.getDocs = getDocs;
      window.getAuth = getAuth;
      window.signInWithEmailAndPassword = signInWithEmailAndPassword;
      window.signOut = signOut;
      window.onAuthStateChanged = onAuthStateChanged;

      // Configuraciones de Tailwind
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            animation: {
              'fade-in-up': 'fadeInUp 0.5s ease-out',
              'fade-in': 'fadeIn 0.5s ease-out',
              'bg-gradient': 'gradientShift 15s ease infinite',
            },
            keyframes: {
              fadeInUp: {
                '0%': { opacity: 0, transform: 'translateY(10px)' },
                '100%': { opacity: 1, transform: 'translateY(0)' },
              },
              fadeIn: {
                '0%': { opacity: 0 },
                '100%': { opacity: 1 },
              },
              gradientShift: {
                '0%': { 'background-position': '0% 50%' },
                '50%': { 'background-position': '100% 50%' },
                '100%': { 'background-position': '0% 50%' },
              },
            }
          },
        }
      }
    </script>

    <style>
        /* Estilos de Fondo Animado: BOLAS DE BINGO Y GRADIENTE */
        .gradient-background {
            background: linear-gradient(-45deg, #0E1086, #480E86, #840E86, #ED47F0);
            background-size: 400% 400%;
            animation: bg-gradient 15s ease infinite;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 3.0;
        }
        
        .bingo-bubbles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .bingo-bubbles li {
            position: absolute;
            display: block;
            list-style: none;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            animation: moveBubbles 25s linear infinite;
            bottom: -150px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        @keyframes moveBubbles {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100vh); opacity: 0; }
        }

        /* ESTILOS PARA COMPRAR CARTAS (extra√≠dos del primer c√≥digo) */
        .bingo-card-image { 
            max-width: 100%; 
            height: auto; 
            border-radius: 0.75rem; 
            border: 4px solid #800080; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.4); 
        }
        
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.85); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            overflow-y: auto; 
            padding: 20px 0; 
        }
        
        .modal-content { 
            background-color: white; 
            border-radius: 1rem; 
            padding: 1.5rem; 
            width: 90%; 
            max-width: 500px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); 
            position: relative; 
        }
        
        .card-item-container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 2px; 
            cursor: pointer; 
            transition: transform 0.1s; 
        }
        
        .card-item-container:hover { 
            transform: scale(1.05); 
        }
        
        .bingo-ball { 
            width: 48px; 
            height: 48px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 18px; 
            font-weight: 900; 
            border-radius: 50%; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); 
            z-index: 2; 
            position: relative;
        }
        
        .ver-tag { 
            font-size: 10px; 
            font-weight: bold; 
            background-color: #fcd34d; 
            color: #1f2937; 
            padding: 1px 6px; 
            margin-top: 4px; 
            border-radius: 4px; 
            border: 1px solid #fbbf24; 
            z-index: 2; 
            position: relative; 
        }
        
        .ver-tag:hover { 
            background-color: #fbbf24; 
        }
        
        /* Estados de Color */
        .status-available .bingo-ball { 
            background-color: #6b21a8; 
            color: white; 
            border: 2px solid #5b21b6; 
        }
        
        .status-selected .bingo-ball { 
            background-color: #fcd34d; 
            color: #1f2937; 
            border: 2px solid #fbbf24; 
            transform: scale(1.1); 
        }
        
        .status-reserved .bingo-ball { 
            background-color: #f97316; 
            color: white; 
            border: 2px solid #ea580c; 
            animation: pulse-orange 2s infinite; 
        }
        
        .status-sold .bingo-ball { 
            background-color: #16a34a; 
            color: white; 
            border: 2px solid #15803d; 
        }
        
        @keyframes pulse-orange { 
            0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); } 
            70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } 
        }
        
        /* Estilos de impresi√≥n y carga */
        @media print {
            body * { visibility: hidden; }
            #root, #root * { visibility: visible; }
            #root { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print, footer, .gradient-background, .bingo-bubbles { display: none !important; }
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #ffffff;
            animation: spin 1s ease infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 font-sans relative">
    
    <div class="gradient-background"></div>

    <ul class="bingo-bubbles">
        <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
    </ul>

<!-- Modal Selecci√≥n de Tablas -->
<div id="cardSelectionModal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-xl font-bold text-gray-800">Selecciona tus Tablas</h3>
            <button onclick="window.hideCardSelectionModal()" class="text-2xl text-gray-500">&times;</button>
        </div>
        
        <div class="flex justify-between text-[10px] font-bold text-gray-500 mb-4 px-2">
            <span class="flex items-center"><div class="w-3 h-3 bg-purple-700 rounded-full mr-1"></div> Libre</span>
            <span class="flex items-center"><div class="w-3 h-3 bg-yellow-400 rounded-full mr-1"></div> Tuya</span>
            <span class="flex items-center"><div class="w-3 h-3 bg-orange-500 rounded-full mr-1"></div> Ocupada</span>
            <span class="flex items-center"><div class="w-3 h-3 bg-green-600 rounded-full mr-1"></div> Vendida</span>
        </div>

        <div id="cardListContainer" class="grid grid-cols-6 sm:grid-cols-8 gap-2 max-h-[60vh] overflow-y-auto p-1"></div>

        <div class="mt-4 border-t pt-4">
            <div class="flex justify-between items-center mb-3">
                <span class="text-gray-600 font-bold">Total a Pagar:</span>
                <span id="totalCostDisplay" class="text-2xl font-black text-green-600">Bs. 0,00</span>
            </div>
            <button onclick="window.preparePayment()" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 transition">
                CONTINUAR A PAGO
            </button>
        </div>
    </div>
</div>

<!-- Modal Preview de Tabla -->
<div id="cardPreviewModal" class="modal">
    <div class="modal-content text-center">
        <h3 class="text-xl font-bold text-gray-800 mb-2">Tabla N¬∞ <span id="previewNum" class="text-purple-600"></span></h3>
        <div id="previewImgContainer" class="flex justify-center mb-4 p-2 bg-gray-100 rounded-lg"></div>
        <p id="previewStatusText" class="font-bold mb-4"></p>
        <div class="flex gap-3 justify-center">
            <!-- El bot√≥n btnPreviewAction se configura din√°micamente en window.openPreview() -->
            <button id="btnPreviewAction" class="flex-1 py-2 bg-green-500 text-white font-bold rounded-lg shadow"></button>
            <button onclick="window.closePreview()" class="flex-1 py-2 bg-gray-300 text-gray-700 font-bold rounded-lg">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal Proceso de Pago -->
<div id="paymentProcessModal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg font-bold text-purple-800">Confirmar Pago</h3>
            <button onclick="window.hidePaymentModal()" class="text-2xl">&times;</button>
        </div>
        
        <div class="bg-yellow-50 text-yellow-800 p-2 rounded text-center text-sm font-bold mb-4 border border-yellow-200">
            ‚è≥ Completa tus datos para reservar las tablas
        </div>

        <div class="space-y-3 mb-4">
            <div class="flex justify-between text-sm border-b border-dashed pb-1">
                <span>Tablas:</span> <span id="payCardsList" class="font-bold text-purple-700"></span>
            </div>
            <div class="flex justify-between text-sm border-b border-dashed pb-1">
                <span>Total:</span> <span id="payTotal" class="font-bold text-green-600 text-lg"></span>
            </div>
        </div>

        <!-- Cambiado: onsubmit llama a window.submitPayment() -->
        <form id="paymentForm" onsubmit="event.preventDefault(); window.submitPayment();" class="space-y-3">
            <input type="text" id="payName" placeholder="Nombre y Apellido" class="w-full p-3 border rounded bg-gray-50" required>
            <input type="tel" id="payPhone" placeholder="Tel√©fono (WhatsApp)" class="w-full p-3 border rounded bg-gray-50" required>
            <input type="number" id="payRef" placeholder="Referencia de pago" class="w-full p-3 border rounded bg-gray-50" required>
            
            <!-- Bot√≥n actualizado: type="submit" mantiene la funcionalidad del formulario -->
            <button type="submit" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition">
                CONFIRMAR COMPRA üöÄ
            </button>
        </form>
        <p id="uploadStatus" class="text-center text-sm mt-2 font-bold hidden"></p>
    </div>
</div>

    <!-- √Årea de resultados de b√∫squeda -->
    <div id="searchResultArea" class="hidden mt-8 bg-white p-6 rounded-2xl shadow-2xl text-center border-2 border-purple-100">
        <h3 id="resultTitle" class="font-bold text-xl text-purple-800 mb-4"></h3>
        <div id="resultContent" class="flex justify-center flex-wrap gap-4"></div>
        <p id="resultStatus" class="text-sm font-bold"></p>
    </div>

    <div id="root" class="relative z-10">
        <div class="h-screen flex items-center justify-center">
            <div class="spinner"></div>
            <p class="ml-4 text-lg text-slate-600">Cargando Bingo Master...</p>
        </div>
    </div>

    <script type="text/babel">
    const { useState, useEffect, createElement } = React;
    
    const firebaseConfig = {
        apiKey: "AIzaSyABUyIEpsAFAJMWAhPXbURFBbyRITj79xM",
        authDomain: "bingoreservas.firebaseapp.com",
        projectId: "bingoreservas",
        storageBucket: "bingoreservas.firebasestorage.app",
        messagingSenderId: "198500053040",
        appId: "1:198500053040:web:865b757df05fe4c5c07df5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    const BINGO_CARDS_BASE_URL = 'https://raw.githubusercontent.com/bingodeprueba/bingodeprueba/main/cartas/'; 
    
    const getCardImageUrl = (playerId) => {
        const cardName = `carta${playerId}.jpg`;
        return `${BINGO_CARDS_BASE_URL}${cardName}`;
    };

    const Search = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('circle', { cx: 11, cy: 11, r: 8 }), createElement('path', { d: "m21 21-4.3-4.3" }));
    const UserPlus = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('path', { d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" }), createElement('circle', { cx: 9, cy: 7, r: 4 }), createElement('line', { x1: 19, y1: 8, x2: 19, y2: 14 }), createElement('line', { x1: 22, y1: 11, x2: 16, y2: 11 }));
    const Trash2 = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('path', { d: "M3 6h18" }), createElement('path', { d: "M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" }), createElement('path', { d: "M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" }), createElement('line', { x1: 10, y1: 11, x2: 10, y2: 17 }), createElement('line', { x1: 14, y1: 11, x2: 14, y2: 17 }));
    const LogOut = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('path', { d: "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" }), createElement('polyline', { points: "16 17 21 12 16 7" }), createElement('line', { x1: 21, y1: 12, x2: 9, y2: 12 }));
    const Check = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('polyline', { points: "20 6 9 17 4 12" }));
    const Hash = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('line', { x1: 4, y1: 9, x2: 20, y2: 9 }), createElement('line', { x1: 4, y1: 15, x2: 20, y2: 15 }), createElement('line', { x1: 10, y1: 3, x2: 8, y2: 21 }), createElement('line', { x1: 16, y1: 3, x2: 14, y2: 21 }));
    const X = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('path', { d: "M18 6 6 18" }), createElement('path', { d: "m6 6 12 12" }));
    const Printer = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('polyline', { points: "6 9 6 2 18 2 18 9" }), createElement('path', { d: "M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" }), createElement('rect', { width: 12, height: 8, x: 6, y: 14 }), createElement('line', { x1: 12, y1: 14, x2: 12, y2: 22 }));
    const Lock = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('rect', { width: 18, height: 11, x: 3, y: 11, rx: 2, ry: 2 }), createElement('path', { d: "M7 11V7a5 5 0 0 1 10 0v4" }));
    const Loader2 = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('path', { d: "M21 12a9 9 0 1 1-6.219-8.56" }));
    const Download = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('path', { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }), createElement('polyline', { points: "7 10 12 15 17 10" }), createElement('line', { x1: 12, y1: 15, x2: 12, y2: 3 }));
    const ShoppingCart = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('circle', { cx: 9, cy: 21, r: 1 }), createElement('circle', { cx: 20, cy: 21, r: 1 }), createElement('path', { d: "M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" }));
    const FullTicket = ({ player }) => {
    if (!player) return null;

      const cardUrl = getCardImageUrl(player.id);
      const downloadFileName = `Bingo_Ticket_${player.id}_${player.name.replace(/\s/g, '_')}.jpg`; 

      const handleDownloadImage = async () => {
          try {
              const response = await fetch(cardUrl);
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.style.display = 'none';
              a.href = url;
              a.download = downloadFileName;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
          } catch (error) {
              console.error('Error al descargar la imagen:', error);
              document.getElementById('modal-message').innerText = '‚ùå Error al intentar descargar la imagen.';
              document.getElementById('error-modal').classList.remove('hidden');
              setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 3000);
          }
      };

      return (
        <div id="bingo-ticket-export" className="bg-white p-4 sm:p-6 rounded-3xl shadow-2xl max-w-3xl mx-auto border-t-8 border-purple-600 relative overflow-hidden">
          <div className="text-center mb-6 relative z-10">
            <div className="inline-flex items-center justify-center gap-2 bg-purple-100 text-purple-700 px-4 py-1 rounded-full text-sm font-bold mb-2">
              <Hash size={14} /> TICKET #{player.id}
            </div>
            <h2 className="text-3xl sm:text-4xl font-black text-slate-800 uppercase">BINGO <span className="text-purple-600"> DE PRUEBA</span></h2>
            <p className="text-slate-500 font-medium text-lg mt-1 uppercase">{player.name}</p>
          </div>
          <div className="relative z-10 flex flex-col items-center justify-center">
             <div className="bg-slate-100 p-2 rounded-xl shadow-inner border border-slate-200">
               <img 
                   src={cardUrl} 
                   alt={`Cart√≥n de Bingo #${player.id}`} 
                   className="max-w-full h-auto rounded-lg shadow-md"
               />
             </div>
             <button 
                 onClick={handleDownloadImage}
                 className="mt-4 bg-green-500 text-white px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-green-600 transition-colors no-print"
             >
                 <Download size={20} /> Descargar Cart√≥n
             </button>
          </div>
          <div className="mt-6 pt-4 border-t border-dashed border-slate-300 flex justify-between items-center text-xs text-slate-400">
            <span>Bingo de prueba</span>
            <span className="flex items-center gap-1"><Check size={12} /> Verificado</span>
          </div>
        </div>
      );
    };

    const App = () => {
      const [activeTab, setActiveTab] = useState('home'); 
      const [players, setPlayers] = useState([]);
      const [searchCode, setSearchCode] = useState('');
      const [foundPlayer, setFoundPlayer] = useState(null);
      const [searchPhone, setSearchPhone] = useState('');
      const [searchResults, setSearchResults] = useState([]);
      
      const [user, setUser] = useState(null);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [authError, setAuthError] = useState('');

      const [newName, setNewName] = useState('');
      const [newId, setNewId] = useState('');
      const [newPhone, setNewPhone] = useState('');
      const [loading, setLoading] = useState(false);
      const [actionLoading, setActionLoading] = useState(false);

      const [logoClicks, setLogoClicks] = useState(0);
      const [adminVisible, setAdminVisible] = useState(false);

      useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
          setUser(currentUser);
        });
        return () => unsubscribe();
      }, []);

      useEffect(() => {
        if (user && activeTab === 'admin') {
          try {
            const q = query(collection(db, "players"));
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
              const playersList = [];
              querySnapshot.forEach((doc) => {
                playersList.push({ id: doc.id, ...doc.data() }); 
              });
              playersList.sort((a, b) => parseInt(a.id) - parseInt(b.id));
              setPlayers(playersList);
              
              if(playersList.length > 0) {
                  const lastId = Math.max(...playersList.map(p => parseInt(p.id)));
                  setNewId(String(lastId + 1).padStart(3, '0'));
              } else {
                  setNewId('001');
              }
            });
            return () => unsubscribe();
          } catch (e) {
            console.error("Error al suscribirse a Firestore:", e);
            setAuthError("Error de conexi√≥n con la base de datos.");
            return () => {}; 
          }
        } else {
            setPlayers([]);
            return () => {};
        }
      }, [user, activeTab]);

      const handleLogoClick = () => {
        setActiveTab('home'); 
        setSearchCode(''); 
        setSearchPhone('');
        setFoundPlayer(null);
        setSearchResults([]);

        const newCount = logoClicks + 1;
        setLogoClicks(newCount);

        if (newCount === 6) {
             setAdminVisible(true);
             document.getElementById('modal-message').innerText = 'üîì Bot√≥n Admin Revelado';
             document.getElementById('error-modal').classList.remove('hidden');
             setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 2000);
        }
      };

      const handleSearch = async (e) => {
        e.preventDefault();
        const formattedCode = searchCode.padStart(3, '0');
        if(!formattedCode || formattedCode.length > 3) return;
        setLoading(true);
        setFoundPlayer(null);

        try {
          const docRef = doc(db, "players", formattedCode);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            setFoundPlayer(docSnap.data());
            setActiveTab('result');
          } else {
             document.getElementById('modal-message').innerText = '‚ùå No encontramos ese n√∫mero de cart√≥n.';
             document.getElementById('error-modal').classList.remove('hidden');
             setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 3000);
          }
        } catch (error) {
          console.error("Error buscando:", error);
           document.getElementById('modal-message').innerText = "Error de conexi√≥n. Intenta m√°s tarde.";
           document.getElementById('error-modal').classList.remove('hidden');
           setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 3000);
        }
        setLoading(false);
      };

      const handleSearchByPhone = async (e) => {
        e.preventDefault();
        if(searchPhone.length < 10) {
          alert("Por favor ingresa un n√∫mero de tel√©fono v√°lido (10 d√≠gitos)");
          return;
        }
        setLoading(true);
        setSearchResults([]);

        try {
          const q = query(collection(db, "players"), where("phone", "==", searchPhone));
          const querySnapshot = await getDocs(q);
          const results = [];
          querySnapshot.forEach((doc) => {
            results.push({ id: doc.id, ...doc.data() });
          });
          setSearchResults(results);
          
          if(results.length === 0) {
            document.getElementById('modal-message').innerText = '‚ùå No se encontraron cartones para este tel√©fono.';
            document.getElementById('error-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 3000);
          }
        } catch (error) {
          console.error("Error buscando por tel√©fono:", error);
          document.getElementById('modal-message').innerText = "Error de conexi√≥n. Intenta m√°s tarde.";
          document.getElementById('error-modal').classList.remove('hidden');
          setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 3000);
        }
        setLoading(false);
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setAuthError('');
        setLoading(true);
        try {
          await signInWithEmailAndPassword(auth, email, password);
          setActiveTab('admin');
        } catch (error) {
          setAuthError('Credenciales incorrectas o usuario no existe. Revisa tu email y contrase√±a.');
        }
        setLoading(false);
      };

      const handleLogout = async () => {
        await signOut(auth);
        setActiveTab('home');
        setAdminVisible(false);
        setLogoClicks(0);
      };

      const handleCreatePlayer = async (e) => {
        e.preventDefault();
        const formattedId = newId.padStart(3, '0');
        if(!newName || !formattedId) return;
        setActionLoading(true);

        try {
          const docRef = doc(db, "players", formattedId);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists() && !window.confirm(`El cart√≥n #${formattedId} ya existe para ${docSnap.data().name}. ¬øQuieres sobrescribirlo?`)) {
              setActionLoading(false);
              return;
          }

          await setDoc(docRef, {
            id: formattedId,
            name: newName,
            phone: newPhone || '',
            createdAt: new Date().toISOString(),
            status: 'vendido'
          });
          
          setNewName('');
          setNewPhone('');
          
          document.getElementById('modal-message').innerText = `‚úÖ Cart√≥n #${formattedId} asignado a ${newName}.`;
          document.getElementById('error-modal').classList.remove('hidden');
          setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 5000);
          
        } catch (error) {
          console.error("Error creando:", error);
           document.getElementById('modal-message').innerText = "Error al guardar en base de datos.";
           document.getElementById('error-modal').classList.remove('hidden');
           setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 5000);
        }
        setActionLoading(false);
      };

      const handleDelete = async (id) => {
        if(window.confirm(`¬øEst√°s seguro de borrar el cart√≥n #${id}?`)) {
          try {
            await deleteDoc(doc(db, "players", id));
          } catch (error) {
             document.getElementById('modal-message').innerText = "Error al eliminar.";
             document.getElementById('error-modal').classList.remove('hidden');
             setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 3000);
          }
        }
      };

      const handlePrint = () => window.print();
      
      const handleDownloadAdmin = async (id, name) => {
          const cardUrl = getCardImageUrl(id);
          const downloadFileName = `Bingo_Ticket_${id}_${name.replace(/\s/g, '_')}.jpg`; 
          
          try {
              const response = await fetch(cardUrl);
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.style.display = 'none';
              a.href = url;
              a.download = downloadFileName;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
          } catch (error) {
              console.error('Error al descargar la imagen:', error);
              document.getElementById('modal-message').innerText = '‚ùå Error al intentar descargar la imagen.';
              document.getElementById('error-modal').classList.remove('hidden');
              setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 3000);
          }
      };

      return (
        <div className="min-h-screen text-slate-800 font-sans selection:bg-purple-200">
          <nav className="bg-white sticky top-0 z-50 border-b border-slate-200 no-print shadow-sm">
            <div className="max-w-5xl mx-auto px-4 h-16 flex justify-between items-center">
              
              <div 
                onClick={handleLogoClick}
                className="flex items-center gap-2 cursor-pointer select-none active:scale-95 transition-transform"
                title="Volver al inicio (Click secreto...)"
              >
                <img 
                src="https://raw.githubusercontent.com/AAlll33/bingosue/main/logo-aponte.png" 
                alt="" 
                className="h-10 w-auto"
                />
                <span className="font-black text-xl tracking-tight text-slate-800">Bingo<span className="text-purple-600"> de prueba</span></span>
              </div>

              <div className="flex items-center gap-4">
                {/* Bot√≥n para comprar cartas */}
                <button 
  onClick={() => {
    // Asegurarse de que las funciones de compra est√©n disponibles
    if (typeof window.showCardSelectionModal === 'function') {
      window.showCardSelectionModal();
    } else {
      // Si no est√°n disponibles, recargar las funciones
      console.log('Cargando funciones de compra...');
      initializePurchaseFunctions();
      if (typeof window.showCardSelectionModal === 'function') {
        window.showCardSelectionModal();
      } else {
        alert('Por favor, recarga la p√°gina para habilitar la compra de cartas');
      }
    }
  }}
  className="text-sm font-medium text-green-600 hover:text-green-700 flex items-center gap-1"
>
  <ShoppingCart size={16}/> COMPRAR üéüÔ∏è
</button>
                
                {user ? (
                 <button onClick={() => setActiveTab('admin')} className="text-sm font-medium text-purple-600 flex items-center gap-1">
                    <Lock size={16}/> ADMIN
                 </button>
                ) : (
                  adminVisible && (
                    <button onClick={() => setActiveTab('admin')} className="text-sm font-medium text-slate-500 hover:text-purple-600 flex items-center gap-1 animate-fade-in">
                    <Lock size={16}/> Admin
                    </button>
                  )
                )}
                
                {user && (
                   <button onClick={handleLogout} className="text-sm font-medium text-purple-500 flex items-center gap-1">
                     <LogOut size={16}/> Salir
                   </button>
                )}
              </div>
            </div>
          </nav>

          <main className="max-w-5xl mx-auto p-4 md:p-8 flex flex-col items-center min-h-[80vh]">

            {activeTab === 'home' && (
              <div className="w-full max-w-4xl mt-10 animate-fade-in-up text-center">
                <div className="mb-8">
                  <h1 className="text-4xl font-black text-slate-900 mb-2">Sistema de Bingo</h1>
                  <p className="text-slate-500">Busca tus cartones o compra nuevos</p>
                </div>

                <div className="grid md:grid-cols-2 gap-6">
                  {/* Buscar por n√∫mero */}
                  <div className="bg-white/70 backdrop-blur-sm p-8 rounded-2xl shadow-xl border border-slate-100">
                    <h3 className="font-bold text-gray-700 mb-4 flex items-center justify-center">
                      <Hash className="mr-2 text-purple-600" size={20} />
                      Buscar por N√∫mero de Cart√≥n
                    </h3>
                    <form onSubmit={handleSearch} className="bg-white p-2 rounded-2xl shadow-xl flex items-center border border-slate-100">
                      <div className="pl-4 text-slate-400"><Hash size={24} /></div>
                      <input 
                        type="text" 
                        value={searchCode}
                        onChange={(e) => setSearchCode(e.target.value)}
                        placeholder="001"
                        maxLength={3}
                        className="w-full p-4 bg-transparent outline-none text-2xl font-black text-slate-800 placeholder:text-slate-300 font-mono"
                      />
                      <button 
                        type="submit"
                        disabled={loading}
                        className="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-xl font-bold transition-all disabled:opacity-50 flex items-center justify-center gap-2 w-20"
                      >
                        {loading ? <Loader2 className="animate-spin" size={24} /> : <Search size={24} />}
                      </button>
                    </form>
                  </div>

                  {/* Buscar por tel√©fono */}
                  <div className="bg-white/70 backdrop-blur-sm p-8 rounded-2xl shadow-xl border border-slate-100">
                    <h3 className="font-bold text-gray-700 mb-4 flex items-center justify-center">
                      <svg className="mr-2 text-purple-600" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                      </svg>
                      Buscar por Tel√©fono
                    </h3>
                    <form onSubmit={handleSearchByPhone} className="bg-white p-2 rounded-2xl shadow-xl flex items-center border border-slate-100">
                      <div className="pl-4 text-slate-400">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                      </div>
                      <input 
                        type="tel" 
                        value={searchPhone}
                        onChange={(e) => setSearchPhone(e.target.value)}
                        placeholder="04129546751"
                        className="w-full p-4 bg-transparent outline-none text-2xl font-black text-slate-800 placeholder:text-slate-300"
                      />
                      <button 
                        type="submit"
                        disabled={loading}
                        className="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-xl font-bold transition-all disabled:opacity-50 flex items-center justify-center gap-2 w-20"
                      >
                        {loading ? <Loader2 className="animate-spin" size={24} /> : <Search size={24} />}
                      </button>
                    </form>
                  </div>
                </div>

                {/* Resultados de b√∫squeda por tel√©fono */}
                {searchResults.length > 0 && (
                  <div className="mt-8 bg-white p-6 rounded-2xl shadow-2xl text-center border-2 border-purple-100">
                    <h3 className="font-bold text-xl text-purple-800 mb-4">Cartones encontrados para: {searchPhone}</h3>
                    <div className="flex justify-center flex-wrap gap-4">
                      {searchResults.map(player => (
                        <div key={player.id} className="bg-purple-100 border border-purple-500 p-4 rounded-lg">
                          <span className="text-2xl font-black text-purple-700">{player.id}</span><br/>
                          <span className="text-xs font-bold text-purple-800">{player.name}</span><br/>
                          <span className="text-xs text-green-600 font-bold">VENDIDO</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'result' && foundPlayer && (
              <div className="w-full animate-fade-in relative z-10">
                <div className="flex justify-between items-center mb-6 no-print bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                  <button onClick={() => { setActiveTab('home'); setFoundPlayer(null); }} className="flex items-center gap-2 text-slate-500 hover:text-slate-800">
                    <X size={18} /> Cerrar B√∫squeda
                  </button>
                  <button onClick={handlePrint} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg flex items-center gap-2 hover:bg-purple-700">
                    <Printer size={18} /> Imprimir (Solo Imagen)
                  </button>
                </div>
                <FullTicket player={foundPlayer} />
              </div>
            )}

            {activeTab === 'admin' && (
              <div className="w-full max-w-4xl animate-fade-in relative z-10">
                {!user ? (
                  <div className="max-w-sm mx-auto bg-white p-8 rounded-2xl shadow-xl border border-purple-50">
                    <h2 className="text-xl font-bold mb-6 text-center">Acceso Administrativo</h2>
                    {authError && <div className="bg-purple-50 text-purple-600 p-3 rounded-lg text-sm mb-4 text-center">{authError}</div>}
                    <form onSubmit={handleLogin} className="space-y-4">
                      <div>
                        <label className="text-xs font-bold text-slate-400">EMAIL</label>
                        <input 
                          type="email" 
                          required
                          className="w-full border p-3 rounded-lg outline-none focus:border-purple-500"
                          value={email}
                          onChange={(e) => setEmail(e.target.value)}
                        />
                      </div>
                      <div>
                        <label className="text-xs font-bold text-slate-400">CONTRASE√ëA</label>
                        <input 
                          type="password" 
                          required
                          className="w-full border p-3 rounded-lg outline-none focus:border-purple-500"
                          value={password}
                          onChange={(e) => setPassword(e.target.value)}
                        />
                      </div>
                      <button disabled={loading} className="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800 flex justify-center">
                        {loading ? <Loader2 className="animate-spin" size={24}/> : "Entrar"}
                      </button>
                    </form>
                  </div>
                ) : (
                  <div className="grid lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-1">
                      <div className="bg-white p-6 rounded-2xl shadow-lg border border-purple-50 sticky top-24">
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-purple-700">
                          <UserPlus size={20}/> Asignar Cart√≥n
                        </h3>
                        <form onSubmit={handleCreatePlayer} className="space-y-4">
                          <div>
                            <label className="text-xs font-bold text-slate-400">N√öMERO DE CART√ìN (001-400)</label>
                            <input 
                              type="text" 
                              value={newId}
                              onChange={(e) => setNewId(e.target.value.replace(/[^0-9]/g, ''))}
                              maxLength={3}
                              placeholder="001"
                              className="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 font-mono font-bold text-red-700"
                            />
                          </div>
                          <div>
                            <label className="text-xs font-bold text-slate-400">NOMBRE CLIENTE</label>
                            <input 
                              type="text" 
                              value={newName}
                              onChange={(e) => setNewName(e.target.value)}
                              placeholder="Ej: Yormary Sue"
                              required
                              className="w-full border-2 border-slate-200 rounded-lg p-2 focus:border-purple-500 outline-none"
                            />
                          </div>
                          <div>
                            <label className="text-xs font-bold text-slate-400">TEL√âFONO (opcional)</label>
                            <input 
                              type="tel" 
                              value={newPhone}
                              onChange={(e) => setNewPhone(e.target.value)}
                              placeholder="04129546751"
                              className="w-full border-2 border-slate-200 rounded-lg p-2 focus:border-purple-500 outline-none"
                            />
                          </div>
                          <button disabled={actionLoading} className="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold shadow-md transition-all flex justify-center">
                            {actionLoading ? <Loader2 className="animate-spin" size={24}/> : "Asignar Cart√≥n"}
                          </button>
                        </form>
                      </div>
                    </div>

                    <div className="lg:col-span-2 bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
                      <div className="p-4 bg-slate-50 border-b border-slate-200 font-bold text-slate-700 flex justify-between items-center">
                        Lista de Cartones ({players.length})
                      </div>
                      <div className="max-h-[500px] overflow-y-auto p-2">
                        {players.map((p) => (
                          <div key={p.id} className="flex justify-between items-center p-3 hover:bg-purple-50 rounded-lg border-b border-slate-50">
                            <div className="flex items-center gap-3">
                              <span className="font-mono font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded text-sm">{p.id}</span>
                              <div>
                                <span className="font-medium">{p.name}</span>
                                {p.phone && <p className="text-xs text-gray-500">{p.phone}</p>}
                              </div>
                            </div>
                            <div className="flex gap-2">
                               <button onClick={() => handleDownloadAdmin(p.id, p.name)} title="Descargar Imagen" className="p-2 text-green-500 hover:bg-green-100 rounded-full"><Download size={16}/></button>
                               <button title="Ver Cart√≥n" onClick={() => { setFoundPlayer(p); setActiveTab('result'); }} className="p-2 text-blue-500 hover:bg-blue-100 rounded-full"><Search size={16}/></button>
                               <button title="Eliminar" onClick={() => handleDelete(p.id)} className="p-2 text-red-500 hover:bg-red-100 rounded-full"><Trash2 size={16}/></button>
                            </div>
                          </div>
                        ))}
                        {players.length === 0 && <p className="text-center p-10 text-slate-400">Sin registros en la base de datos.</p>}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </main>
          
          <div id="error-modal" className="hidden fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-xl shadow-2xl z-[9999] transition-opacity duration-300">
              <p id="modal-message" className="flex items-center gap-2 font-medium"></p>
          </div>

          <footer className="mt-16 py-6 border-t border-slate-200 text-center text-slate-600 bg-white/70 backdrop-blur-sm relative z-10 no-print">
              <div className="max-w-5xl mx-auto px-4">
                  <p className="text-sm font-semibold mb-1 flex items-center justify-center gap-2">
                      2025 Bingo de prueba -
                    <img src="img/logo/massonlogo.png" alt="Masson Logo" className="h-4 inline-block" />
                      <span className="font-black text-black-600">
                          Masson¬©
                      </span>
              Todos los derechos reservados.
                  </p>
                  <p className="text-xs text-slate-500 mt-2">
                      P√°gina creada por <span className="font-bold text-black-700">Masson¬©</span>. 
                      Escribe al WhatsApp <span className="font-bold text-green-600">+584226431972</span> para m√°s informaci√≥n.
                  </p>
              </div>
          </footer>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    
    <!-- INCLUIR LAS FUNCIONES DE COMPRA Y B√öSQUEDA -->
    <script>
    // Inicializar variables globales para compra
    window.selectedCards = JSON.parse(localStorage.getItem('selected_cards')) || [];
    window.CARD_PRICE = 300;
    window.TOTAL_CARDS = 75;
    
    // Hacer las funciones accesibles globalmente
    window.showCardSelectionModal = showCardSelectionModal;
    window.hideCardSelectionModal = hideCardSelectionModal;
    window.renderGrid = renderGrid;
    window.getStatus = getStatus;
    window.handleBallClick = handleBallClick;
    window.saveLocalSelection = saveLocalSelection;
    window.updateTotal = updateTotal;
    window.openPreview = openPreview;
    window.closePreview = closePreview;
    window.preparePayment = preparePayment;
    window.hidePaymentModal = hidePaymentModal;
    window.submitPayment = submitPayment;
    window.searchCardByPhone = searchCardByPhone;
    window.searchCard = searchCard;
    
    // Funci√≥n helper para searchCard (b√∫squeda individual)
    
        window.showCardSelectionModal = function() {
        console.log('Mostrando modal de compra');
        const modal = document.getElementById('cardSelectionModal');
        if (modal) {
            document.getElementById('cardPreviewModal').style.display = 'none';
            document.getElementById('paymentProcessModal').style.display = 'none';
            modal.style.display = 'flex';
            window.renderGrid();
            window.updateTotal();
        } else {
            console.error('Modal no encontrado');
        }
    };
    
    window.hideCardSelectionModal = function() {
        const modal = document.getElementById('cardSelectionModal');
        if (modal) modal.style.display = 'none';
    };
    
    window.renderGrid = function() {
        const container = document.getElementById('cardListContainer');
        if (!container) return;
        
        container.innerHTML = '';
        for(let i = 1; i <= window.TOTAL_CARDS; i++) {
            const st = window.getStatus(i);
            let tag = 'VER';
            if(st === 'sold') tag = 'VENDIDA';
            if(st === 'reserved') tag = 'OCUPADA';
            if(st === 'selected') tag = 'TUYA';

            const div = document.createElement('div');
            div.className = `card-item-container status-${st}`;
            
            div.innerHTML = `
                <div class="bingo-ball" onclick="window.handleBallClick(${i}, '${st}')">${i}</div>
                <span class="ver-tag" onclick="event.stopPropagation(); window.openPreview(${i})">${tag}</span>
            `;
            container.appendChild(div);
        }
    };
    
    window.getStatus = function(n) {
        if(window.selectedCards.includes(n)) return 'selected';
        return 'available';
    };
    
    window.handleBallClick = function(n, st) {
        if(st === 'sold' || st === 'reserved') {
            window.openPreview(n);
        } else {
            if(window.selectedCards.includes(n)) {
                window.selectedCards = window.selectedCards.filter(x => x !== n);
            } else {
                window.selectedCards.push(n);
            }
            window.saveLocalSelection();
            window.updateTotal();
            window.renderGrid();
        }
    };
    
    window.saveLocalSelection = function() {
        localStorage.setItem('selected_cards', JSON.stringify(window.selectedCards));
    };
    
    window.updateTotal = function() {
        const tot = window.selectedCards.length * window.CARD_PRICE;
        const display = document.getElementById('totalCostDisplay');
        if (display) {
            display.textContent = `Bs. ${tot.toFixed(2)}`;
        }
    };
    
    window.openPreview = function(n) {
        const st = window.getStatus(n);
        const btn = document.getElementById('btnPreviewAction');
        const txt = document.getElementById('previewStatusText');
        const previewNum = document.getElementById('previewNum');
        const previewImgContainer = document.getElementById('previewImgContainer');
        
        if (!previewNum || !previewImgContainer) return;
        
        previewNum.textContent = n;
        previewImgContainer.innerHTML = 
            `<img src="https://via.placeholder.com/300x200/6b21a8/ffffff?text=Tabla+${n}" class="bingo-card-image">`;
        
        if(st === 'sold') {
            txt.textContent = `‚ùå VENDIDA`;
            txt.className = "text-red-600 font-bold mb-4";
            btn.style.display = 'none';
        } else if(st === 'reserved') {
            txt.textContent = `‚è≥ OCUPADA`;
            txt.className = "text-orange-500 font-bold mb-4";
            btn.style.display = 'none';
        } else {
            const isSel = window.selectedCards.includes(n);
            txt.textContent = isSel ? "¬øYa no quieres esta tabla?" : "¬øTe gusta esta tabla?";
            txt.className = "text-gray-700 font-bold mb-4";
            btn.style.display = 'block';
            btn.textContent = isSel ? "QUITAR DE MI LISTA" : "AGREGAR A MI LISTA";
            btn.className = isSel ? "flex-1 py-2 bg-red-500 text-white font-bold rounded-lg" : "flex-1 py-2 bg-green-500 text-white font-bold rounded-lg";
            btn.onclick = () => {
                if(isSel) window.selectedCards = window.selectedCards.filter(x => x !== n);
                else window.selectedCards.push(n);
                window.saveLocalSelection();
                window.updateTotal();
                window.closePreview();
                window.showCardSelectionModal();
            };
        }
        
        document.getElementById('cardSelectionModal').style.display = 'none';
        document.getElementById('cardPreviewModal').style.display = 'flex';
    };
    
    window.closePreview = function() {
        document.getElementById('cardPreviewModal').style.display = 'none';
        window.showCardSelectionModal();
    };
    
    window.preparePayment = function() {
        if(window.selectedCards.length === 0) {
            alert("Selecciona al menos una tabla");
            return;
        }
        
        document.getElementById('payName').value = '';
        document.getElementById('payPhone').value = '';
        document.getElementById('payRef').value = '';
        document.getElementById('fileNameDisplay').textContent = '';

        window.hideCardSelectionModal();
        document.getElementById('paymentProcessModal').style.display = 'flex';
        
        document.getElementById('payCardsList').textContent = window.selectedCards.join(', ');
        document.getElementById('payTotal').textContent = `Bs. ${(window.selectedCards.length * window.CARD_PRICE).toFixed(2)}`;
    };
    
    window.hidePaymentModal = function() {
        document.getElementById('paymentProcessModal').style.display = 'none';
        window.showCardSelectionModal();
    };
    
    window.submitPayment = async function() {
        const name = document.getElementById('payName').value;
        const phone = document.getElementById('payPhone').value.replace(/\D/g,'');
        const ref = document.getElementById('payRef').value;
        const statusMsg = document.getElementById('uploadStatus');

        if(!name || phone.length < 10 || !ref) {
            statusMsg.textContent = "Por favor, completa todos los campos.";
            statusMsg.className = "text-center text-sm mt-2 font-bold text-red-600 block";
            return;
        }

        statusMsg.textContent = "Procesando pago... ‚è≥";
        statusMsg.className = "text-center text-sm mt-2 font-bold text-blue-600 block";

        try {
            // Aqu√≠ ir√≠a la l√≥gica para guardar en Firebase
            statusMsg.textContent = "¬°Pago enviado correctamente! üéâ";
            statusMsg.className = "text-center text-sm mt-2 font-bold text-green-600 block";
            
            // Limpiar selecci√≥n
            window.selectedCards = [];
            window.saveLocalSelection();
            
            setTimeout(() => {
                window.hidePaymentModal();
                alert("Tu pago ha sido enviado. Espera la confirmaci√≥n.");
            }, 1500);

        } catch(e) {
            console.error("Error al procesar pago:", e);
            statusMsg.textContent = `Error: ${e.message}`;
            statusMsg.className = "text-center text-sm mt-2 font-bold text-red-600 block";
        }
    };
    
    console.log('Funciones de compra inicializadas');
}

// Llama a initializePurchaseFunctions cuando se cargue la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    initializePurchaseFunctions();
});
        
        function searchCard() {
        const n = parseInt(document.getElementById('cardNumberInput')?.value);
        if(!n) return;
        
        // Crear elemento de resultados si no existe
        let resultArea = document.getElementById('searchResultArea');
        if (!resultArea) {
            resultArea = document.createElement('div');
            resultArea.id = 'searchResultArea';
            resultArea.className = 'mt-8 bg-white p-6 rounded-2xl shadow-2xl text-center border-2 border-purple-100';
            document.querySelector('main').appendChild(resultArea);
        }
        
        const content = document.getElementById('resultContent') || (() => {
            const div = document.createElement('div');
            div.id = 'resultContent';
            div.className = 'flex justify-center flex-wrap gap-4';
            resultArea.appendChild(div);
            return div;
        })();
        
        const title = document.getElementById('resultTitle') || (() => {
            const h3 = document.createElement('h3');
            h3.id = 'resultTitle';
            h3.className = 'font-bold text-xl text-purple-800 mb-4';
            resultArea.insertBefore(h3, content);
            return h3;
        })();
        
        resultArea.classList.remove('hidden');
        title.textContent = `Tabla #${n}`;
        content.innerHTML = `
            <div class="text-center">
                <img src="https://via.placeholder.com/200x300/6b21a8/ffffff?text=Tabla+${n}" 
                     class="bingo-card-image w-48 mx-auto mb-2">
                <p class="font-bold text-purple-600 text-xl">DISPONIBLE</p>
                <button onclick="handleBallClick(${n}, 'available')" 
                        class="inline-block mt-2 bg-green-500 text-white px-4 py-1 rounded">
                    Comprar esta tabla
                </button>
            </div>`;
    }
    
    // Crear input para b√∫squeda individual si no existe
    document.addEventListener('DOMContentLoaded', function() {
        const mainElement = document.querySelector('main');
        if (mainElement && !document.getElementById('cardNumberInput')) {
            const searchDiv = document.createElement('div');
            searchDiv.className = 'mt-6 bg-white/70 backdrop-blur-sm p-6 rounded-2xl shadow-xl border border-slate-100';
            searchDiv.innerHTML = `
                <h3 class="font-bold text-gray-700 mb-4 text-center">Buscar tabla individual</h3>
                <div class="flex gap-2">
                    <input type="number" id="cardNumberInput" placeholder="N¬∞ de tabla (1-75)" 
                           class="flex-1 p-3 border rounded-lg focus:border-purple-500 outline-none"
                           min="1" max="75">
                    <button onclick="searchCard()" 
                            class="bg-purple-600 text-white p-3 rounded-lg font-bold hover:bg-purple-700 transition">
                        Buscar
                    </button>
                </div>
            `;
            mainElement.appendChild(searchDiv);
        }
    });

        function initializePurchaseFunctions() {
    // Inicializar variables globales para compra
    window.selectedCards = JSON.parse(localStorage.getItem('selected_cards')) || [];
    window.CARD_PRICE = 300;
    window.TOTAL_CARDS = 75;
    </script>
    
  <script language="JavaScript">
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) {
        if(event.keyCode == 123) { // Evita F12
           return false;
        }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { // Evita Ctrl+Shift+I
           return false;
        }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { // Evita Ctrl+Shift+C
           return false;
        }
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // Evita Ctrl+U (Ver fuente)
           return false;
        }
    }
  </script>
</body>
</html>
